(function(){"use strict";const f="globalMusicPlayerState";function A(){const e=document.getElementById("global-music-player");if(!e)return[];const t=e.dataset.musicList;if(!t)return[];try{return JSON.parse(t)}catch(e){return console.error("音乐列表解析失败:",e),[]}}function s(){const n={currentIndex:o,currentTime:e.currentTime,isPlaying:t,volume:e.volume,timestamp:Date.now()};try{localStorage.setItem(f,JSON.stringify(n))}catch(e){console.error("保存播放状态失败:",e)}}function d(){try{const e=localStorage.getItem(f);if(!e)return null;const t=JSON.parse(e);return Date.now()-t.timestamp>36e5?(localStorage.removeItem(f),null):t}catch(e){return console.error("恢复播放状态失败:",e),null}}const i=A();if(i.length===0){const e=document.getElementById("global-music-player");e&&e.classList.add("hidden");return}const e=new Audio;e.preload="auto",e.crossOrigin="anonymous";let o=0,t=!1;const _=document.getElementById("global-music-title"),y=document.getElementById("global-music-artist"),n=document.getElementById("global-music-play-pause"),b=document.getElementById("global-music-prev"),v=document.getElementById("global-music-next"),m=document.getElementById("global-music-progress-bar"),p=document.getElementById("global-music-progress-fill"),w=document.getElementById("global-music-current-time"),r=document.getElementById("global-music-duration"),h=document.getElementById("global-music-volume"),l=document.getElementById("global-music-toggle"),j=document.getElementById("global-music-expanded");if(!e||!n)return;function a(a,r=!1){if(a<0||a>=i.length)return;o=a;const c=i[a];t&&(e.pause(),t=!1,n&&(n.textContent="▶")),e.src="",e.load(),e.src=c.url,_&&(_.textContent=c.title),y&&(y.textContent=c.artist||"未知艺术家"),e.load(),r&&e.addEventListener("loadedmetadata",function t(){const n=d();n&&n.currentIndex===a&&(e.currentTime=n.currentTime),e.removeEventListener("loadedmetadata",t)},{once:!0}),E(),s()}function E(){const e=document.querySelectorAll(".music-player-playlist-item");e.forEach((e,t)=>{t===o?e.classList.add("active"):e.classList.remove("active")})}function O(){if(t)e.pause(),n.textContent="▶",t=!1,s();else{e.readyState===0&&e.load();const o=e.play();o!==0[0]&&o.then(()=>{n.textContent="⏸",t=!0,s()}).catch(e=>{console.error("播放失败:",e),t=!1,n.textContent="▶"})}}function x(){const r=o-1<0?i.length-1:o-1;a(r),t&&setTimeout(()=>{e.play().then(()=>{t=!0,n.textContent="⏸",s()})},100)}function g(){const r=(o+1)%i.length;a(r),t&&setTimeout(()=>{e.play().then(()=>{t=!0,n.textContent="⏸",s()})},100)}function C(){if(e.duration){const t=e.currentTime/e.duration*100;p&&(p.style.width=t+"%"),w&&(w.textContent=u(e.currentTime)),r&&(r.textContent=u(e.duration)),Math.floor(e.currentTime)%5===0&&s()}}function u(e){if(isNaN(e))return"0:00";const t=Math.floor(e/60),n=Math.floor(e%60);return`${t}:${String(n).padStart(2,"0")}`}if(n.addEventListener("click",O),b&&b.addEventListener("click",x),v&&v.addEventListener("click",g),m&&m.addEventListener("click",t=>{const n=m.getBoundingClientRect(),o=(t.clientX-n.left)/n.width;e.currentTime=o*e.duration,s()}),h){const t=d();t&&t.volume!==0[0]?(e.volume=t.volume,h.value=t.volume*100):e.volume=.5,h.addEventListener("input",t=>{const n=t.target.value/100;e.volume=n,s()})}if(l&&j){let e=!1;l.addEventListener("click",()=>{e=!e,j.classList.toggle("show",e),l.classList.toggle("collapsed",!e),l.textContent=e?"▲":"▼"})}const k=document.querySelectorAll(".music-player-playlist-item");k.forEach((o,i)=>{o.addEventListener("click",()=>{a(i),t&&setTimeout(()=>{e.play().then(()=>{t=!0,n.textContent="⏸",s()})},100)})}),e.addEventListener("timeupdate",C),e.addEventListener("ended",g),e.addEventListener("loadedmetadata",()=>{r&&(r.textContent=u(e.duration))}),e.addEventListener("error",e=>{console.error("音频加载错误:",e),t&&(t=!1,n&&(n.textContent="▶"))}),window.addEventListener("beforeunload",()=>{s()}),document.addEventListener("visibilitychange",()=>{document.hidden&&s()});const c=d();c&&c.currentIndex!==0[0]?(o=c.currentIndex,a(o,!0),c.isPlaying&&setTimeout(()=>{e.addEventListener("canplay",function o(){e.play().then(()=>{t=!0,n.textContent="⏸",s()}).catch(e=>{console.log("自动播放被阻止，需要用户交互"),t=!1}),e.removeEventListener("canplay",o)},{once:!0})},500)):i.length>0&&a(0),setInterval(s,1e4)})()